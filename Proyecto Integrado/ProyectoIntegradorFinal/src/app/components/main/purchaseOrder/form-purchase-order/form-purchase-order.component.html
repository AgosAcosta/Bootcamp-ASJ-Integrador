<div class="container">
  <form #myForm="ngForm" (ngSubmit)="createNewPuchseOrder(myForm)">
    <div class="row">
      <div class="col-6">
        <!-- Sección Información Orden -->
        <fieldset>
          <legend>Detalle de Orden de compra:</legend>
          <div class="form-group">
            <label for="idPurchaseOrder">N° Orden:</label>
            <input
              type="text"
              class="form-control"
              name="idPurchaseOrder"
              id="idPurchaseOrder"
              required
              [(ngModel)]="newPurchaseOrder.idPurchaseOrder"
              [ngModelOptions]="{ standalone: true }"
              disabled
            />
          </div>

          <div class="row">
            <div class="col">
              <div class="form-group">
                <label for="dateIssue">Fecha Emisión:</label>
                <input
                  type="date"
                  class="form-control"
                  name="dateIssue"
                  id="dateIssue"
                  [min]="date | date : 'yyyy-MM-dd'"
                  required
                  [disabled]="isUpdate"
                  [(ngModel)]="newPurchaseOrder.dateIssue"
                  [ngModelOptions]="{ standalone: true }"
                  #dateIssue="ngModel"
                  [ngClass]="dateIssue.errors ? 'is-invalid' : 'is-valid'"
                />
                <div *ngIf="dateIssue.errors?.['required']" class="col-auto">
                  <span class="form-text">Se debe completar este campo</span>
                </div>
              </div>
            </div>
            <div class="col">
              <div class="form-group">
                <label for="dateDelivery">Fecha de Entrega:</label>
                <input
                  type="date"
                  class="form-control"
                  name="dateDelivery"
                  id="dateDelivery"
                  [min]="getMinDateShippingTemplate()"
                  required
                  [(ngModel)]="newPurchaseOrder.dateDelivery"
                  [ngModelOptions]="{ standalone: true }"
                  #dateDelivery="ngModel"
                  [ngClass]="dateDelivery.errors ? 'is-invalid' : 'is-valid'"
                />
                <div *ngIf="dateDelivery.errors?.['required']" class="col-auto">
                  <span class="form-text">Se debe completar este campo</span>
                </div>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="recepcion">Información de recepción:</label>
            <textarea
              type="text"
              class="form-control"
              name="recepcion"
              id="recepcion"
              minlength="1"
              required
              [(ngModel)]="newPurchaseOrder.recepcion"
              #recepcion="ngModel"
              [ngClass]="recepcion.errors ? 'is-invalid' : 'is-valid'"
            >
            </textarea>
            <div *ngIf="recepcion.errors?.['minlength']" class="col-auto">
              <span class="form-text">Debe tener al menos 1 caracteres</span>
            </div>
            <div *ngIf="recepcion.errors?.['required']" class="col-auto">
              <span class="form-text">Se debe completar este campo</span>
            </div>
          </div>
          <div class="row">
            <div class="col-2 d-flex align-content-end" *ngIf="!supplierPoin">
              <img
                src="{{ supplierLogo }}"
                alt=""
                width="70px"
                height="70px"
                class="img-thumbnail"
              />
            </div>
            <div class="col">
              <div *ngIf="newPurchaseOrder.total > 0">
                <label>Proveedor:</label>
                <input
                  type="text"
                  id="supplier"
                  class="form-control"
                  [readonly]="true"
                  [value]="newPurchaseOrder.supplier"
                  disabled
                />
              </div>
            </div>

            <table class="table">
              <thead>
                <tr>
                  <th>Producto</th>
                  <th>Cantidad</th>
                  <th>Subtotal</th>
                </tr>
              </thead>
              <tbody>
                <tr
                  *ngFor="let item of newPurchaseOrder.products; let i = index"
                >
                  <td>{{ item.nameProduct }}</td>
                  <td>{{ item.unitProduct }}</td>
                  <td>{{ item.unitProduct * item.priceProduct | currency }}</td>
                </tr>
              </tbody>
            </table>

            <div
              *ngIf="detailProducts.unitProduct > 0"
              class="form-group d-flex align-items-center"
            >
              <label>Total</label>
              <input
                type="text"
                id="priceProduct"
                class="form-control"
                [readonly]="true"
                [value]="newPurchaseOrder.total | currency"
                disabled
              />
            </div>
          </div>
          <div class="text-center">
            <button
              type="submit"
              class="btn btn-success"
              [disabled]="
                isUpdate
                  ? false
                  : !myForm.valid || newPurchaseOrder.total === 0 || isSave
              "
            >
              Guardar
            </button>
            <button type="button" class="btn btn-danger" (click)="ClearForm()">
              Limpiar
            </button>
            <button
              type="button"
              class="btn btn-primary"
              routerLink="/list-purchase-order"
            >
              Volver
            </button>
          </div>
        </fieldset>

        <!-- Sección Detalle Orden -->
      </div>

      <div class="col-6">
        <fieldset *ngIf="!isUpdate">
          <div class="row">
            <div class="col">
              <div class="form-group">
                <label for="supplierName">Proveedor:</label>
                <select
                  class="form-control"
                  name="supplierName"
                  [(ngModel)]="newPurchaseOrder.supplier"
                  [ngModelOptions]="{ standalone: true }"
                  required
                  (change)="onSupplierSelected(newPurchaseOrder.supplier)"
                  [disabled]="!supplierPoin || isUpdate"
                  #supplier="ngModel"
                  [ngClass]="supplier.errors ? 'is-invalid' : 'is-valid'"
                >
                  <option value="" disabled selected>
                    Selecciona el proveedor
                  </option>
                  <option
                    *ngFor="let name of suppliers"
                    value="{{ name.nameSupplier }}"
                  >
                    {{ name.nameSupplier }}
                  </option>
                </select>
                <div *ngIf="!newPurchaseOrder.supplier" class="col-auto">
                  <span class="form-text">Se debe completar este campo</span>
                </div>
              </div>
            </div>
            <div class="col">
              <div class="form-group">
                <label for="product">Producto:</label>
                <select
                  class="form-control"
                  name="product"
                  [(ngModel)]="detailProducts.nameProduct"
                  (ngModelChange)="onProductSelected()"
                  required
                  [disabled]="isUpdate"
                >
                  <option value="" disabled selected>
                    Selecciona el producto
                  </option>
                  <option
                    *ngFor="let product of products"
                    [value]="product.nameProduct"
                  >
                    {{ product.nameProduct }}
                  </option>
                </select>
                <div *ngIf="!detailProducts.nameProduct" class="col-auto">
                  <span class="form-text">Se debe completar este campo</span>
                </div>
              </div>
            </div>
          </div>
          <div class="row d-flex align-items-center">
            <div class="col">
              <div class="form-group">
                <label for="priceProduct">Precio:</label>
                <input
                  type="text"
                  id="priceProduct"
                  class="form-control"
                  [readonly]="true"
                  [value]="selectedProduct?.priceProduct | currency"
                  disabled
                />
              </div>
            </div>
            <div class="col">
              <div class="form-group">
                <label for="unitProduct">Cantidad:</label>
                <input
                  type="number"
                  class="form-control"
                  name="unitProduct"
                  min="0"
                  required
                  [(ngModel)]="detailProducts.unitProduct"
                  [ngModelOptions]="{ standalone: true }"
                  (ngModelChange)="calculateTotal()"
                  [disabled]="isUpdate"
                />
              </div>
            </div>

            <div class="col">
              <button
                *ngIf="!isUpdate || detailProducts.unitProduct < 0"
                type="button"
                class="btn btn-primary"
                (click)="addOrderDetails()"
              >
                <i class="bi bi-plus"></i> Agregar
              </button>
            </div>
          </div>

          <div
            *ngIf="detailProducts.unitProduct <= 0"
            class="col-auto text-center"
          >
            <span class="form-text">La cantidad no puede ser menor a 0</span>
          </div>
        </fieldset>
      </div>
    </div>
  </form>
</div>
